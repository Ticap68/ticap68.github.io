<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">
    <link rel="stylesheet" href="css/site.css">
    <link rel="stylesheet" href="css/leaflet.awesome-markers.css">
    <script src="js/leaflet.awesome-markers.js"></script>
</head>

<body>
    <div class="container">
        <div id="map" style="width: 100%; height: 100%;"></div>
        <div id="inputsFinesse">
            Calculer une finesse envisagée : <br><br>
            <form id="calculator-form">
                <label for="vitesse">Vitesse :</label>
                <input type="number" id="vitesse" min="0" step="0.1"> km/h
                <br>
                <label for="tauxChute">Taux de chute :</label>
                <input type="number" id="tauxChute" min="0" step="0.1"> m/s
                <br>
                <button type="submit">Calculer</button>
            </form> <br>

            Finesse = <span id="finesse">___</span> <br>
        </div>

        <div id="colonne2">
            <!-- bouton pour ajouter un marqueur -->
            <button id="set-a1-button">Placer le point A1</button><br><br>
            <button id="set-a2-button">Placer le point A2</button><br><br>
            <button id="remove-a1-button">Supprimer le point A1</button><br><br>
            <button id="remove-a2-button">Supprimer le point A2</button><br><br>

            Altitude sol départ A1 = <span id="a1">___</span> mètre<br>
            Altitude sol arrivée A2 = <span id="a2">___</span> mètre<br><br>

            <!-- bouton pour supprimer les marqueurs -->
            <button id="remove-marker-button">Enlever tous les points</button><br>
        </div>

        <div id="colonne3">
            <button id="actualiser">Actualiser</button> <br><br>

            Distance entre A1 et A2 = <span id="distance">___</span> mètre<br>
            H1 : distance / finesse = <span id="hauteur">___</span> mètre<br><br>

            <b>Altitude de départ requise par rapport à la finesse calculée en premier</b>: <br A2 + H1=<span
                id="altiDepart">___</span> mètre<br><br>
            <b>Altitude de déclenchement requise par rapport au sol</b>:<br>
            <label for="altiDeclench">Pour un déclenchement à</label>
            <input type="number" id="altiDeclench" min="0" step="1"> mètre<br>
            <button id="calcul">Calculer la hauteur requise de lancement</button> <br><br>

            Hauteur requise de lancement = <span id="hauteurRequise">___</span> mètre<br><br>

            <button id="message">Message</button><br><br>

            <div id="afficheCalcul">
                Votre calcul a été effectué avec succès !
            </div>
        </div>
    </div>

    <script>
        var map = L.map('map').setView([46.2276, 2.2137], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
        }).addTo(map);

        var redIcon = L.AwesomeMarkers.icon({
            icon: 'home',
            markerColor: 'red'
        });

        var greenIcon = L.AwesomeMarkers.icon({
            icon: 'home',
            markerColor: 'green'
        });

        var markerA1 = null;
        var markerA2 = null;

        function getAlti(marker) {
            var lat = marker.getLatLng().lat;
            var lng = marker.getLatLng().lng;

            var url = "https://api.open-elevation.com/api/v1/lookup?locations=" + lat + "," + lng;

            fetch(url)
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {
                    var elevation = data.results[0].elevation;
                    var altiSpan;

                    if (marker === markerA1) {
                        altiSpan = document.getElementById('a1');
                    } else if (marker === markerA2) {
                        altiSpan = document.getElementById('a2');
                    }

                    if (altiSpan) {
                        altiSpan.innerHTML = elevation.toFixed(2);
                    }
                })
                .catch(function (error) {
                    console.log(error);
                });
        }
        map.on('click', function (e) {
            if (markerA1 && markerA2) {
                return;
            }

            if (!markerA1) {
                markerA1 = L.marker(e.latlng, { icon: redIcon }).addTo(map);
                markerA1.bindPopup("A1");
                getAlti(markerA1);
            } else if (!markerA2) {
                markerA2 = L.marker(e.latlng, { icon: greenIcon }).addTo(map);
                markerA2.bindPopup("A2");
                getAlti(markerA2);
            }
        });

        // Référence aux boutons HTML
        var setA1Button = document.getElementById('set-a1-button');
        var setA2Button = document.getElementById('set-a2-button');
        var removeA1Button = document.getElementById('remove-a1-button');
        var removeA2Button = document.getElementById('remove-a2-button');

        // Event listeners for setting A1 and A2 markers
        setA1Button.addEventListener('click', function () {
            map.once('click', function (e) {
                if (markerA1) {
                    markerA1.remove();
                    markerA1 = null;
                }
                markerA1 = L.marker(e.latlng, { icon: redIcon }).addTo(map);
                markerA1.bindPopup("A1");
                getAlti(markerA1);
            });
        });
        setA2Button.addEventListener('click', function () {
            map.once('click', function (e) {
                if (markerA2) {
                    markerA2.remove();
                    markerA2 = null;
                }

                markerA2 = L.marker(e.latlng, { icon: greenIcon }).addTo(map);
                markerA2.bindPopup("A2");
                getAlti(markerA2);
            });
        });

        // Event listeners for removing A1 and A2 markers
        removeA1Button.addEventListener('click', function () {
            if (markerA1) {
                markerA1.remove();
                markerA1 = null;
                document.getElementById('a1').innerHTML = "___";
            }
        });

        removeA2Button.addEventListener('click', function () {
            if (markerA2) {
                markerA2.remove();
                markerA2 = null;
                document.getElementById('a2').innerHTML = "___";
            }
        });

        // Event listener for removing all markers
        var removeMarkerButton = document.getElementById('remove-marker-button');
        removeMarkerButton.addEventListener('click', function () {
            if (markerA1) {
                markerA1.remove();
                markerA1 = null;
                document.getElementById('a1').innerHTML = "___";
            }
            if (markerA2) {
                markerA2.remove();
                markerA2 = null;
                document.getElementById('a2').innerHTML = "___";
            }
        });

        var calculatorForm = document.getElementById('calculator-form');
        calculatorForm.addEventListener('submit', function (event) {
            event.preventDefault();

            var vitesse = document.getElementById('vitesse').value;
            var tauxChute = document.getElementById('tauxChute').value;

            var finesse = vitesse / tauxChute;
            document.getElementById('finesse').innerHTML = finesse.toFixed(2);
        });

        var calculButton = document.getElementById('calcul');
        calculButton.addEventListener('click', function () {
            var altiDeclench = document.getElementById('altiDeclench').value;

            var altiDepart = parseFloat(document.getElementById('a2').innerHTML) + parseFloat(document.getElementById('hauteur').innerHTML);
            document.getElementById('altiDepart').innerHTML = altiDepart.toFixed(2);

            var hauteurRequise = altiDepart - altiDeclench;
            document.getElementById('hauteurRequise').innerHTML = hauteurRequise.toFixed(2);

            var afficheCalcul = document.getElementById('afficheCalcul');
            afficheCalcul.style.display = "block";
        });
        var messageButton = document.getElementById('message');
        messageButton.addEventListener('click', function () {
            var hauteurRequise = document.getElementById('hauteurRequise').innerHTML;
            var message = "La hauteur requise de lancement est de " + hauteurRequise + " mètre.";
            alert(message);
        });
    </script>
</body>

</html>